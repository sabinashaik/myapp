pipeline {
  agent any

  triggers { githubPush() }

  environment {
    TOMCAT_URL  = "http://52.203.118.246:8082/manager/text"
    APP_NAME    = "myapp"
    NOTIFY_TO   = "sabinashaik228@gmail.com"
    FAIL_STAGE  = ""
  }

  tools {
    maven "MAVEN3"
    jdk "JDK21"
  }

  stages {

    stage('Checkout') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          git branch: 'main',
              url: 'https://github.com/sabinashaik/myapp.git',
              credentialsId: 'github-creds'
        }
      }
      post {
        failure { script { env.FAIL_STAGE = "Checkout" } }
      }
    }

    stage('Build + Test + Package') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          sh 'mvn -U clean test package'
        }
      }
      post {
        failure { script { env.FAIL_STAGE = "Build + Test + Package" } }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          withSonarQubeEnv('SonarQube') {
            sh 'mvn sonar:sonar'   // keep correct command here
          }
        }
      }
      post {
        failure { script { env.FAIL_STAGE = "SonarQube Analysis" } }
      }
    }

    stage('Upload to Nexus') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          withCredentials([usernamePassword(
            credentialsId: 'nexus-creds',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PASS'
          )]) {
            sh '''
              mvn deploy -DskipTests \
                -Dnexus.username=$NEXUS_USER \
                -Dnexus.password=$NEXUS_PASS
            '''
          }
        }
      }
      post {
        failure { script { env.FAIL_STAGE = "Upload to Nexus" } }
      }
    }

    stage('Deploy to Tomcat (Docker)') {
      steps {
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          withCredentials([usernamePassword(
            credentialsId: 'tomcat-creds',
            usernameVariable: 'TOMCAT_USER',
            passwordVariable: 'TOMCAT_PASS'
          )]) {
            sh '''
              set -e
              echo "Deploying WAR to Tomcat..."
              ls -l target || true

              curl --fail -v -u $TOMCAT_USER:$TOMCAT_PASS \
                -T target/${APP_NAME}.war \
                "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"
            '''
          }
        }
      }
      post {
        failure { script { env.FAIL_STAGE = "Deploy to Tomcat (Docker)" } }
      }
    }
  }

  post {
    success {
      mail(
        to: "${env.NOTIFY_TO}",
        subject: "Pipeline",
        body: """SUCCESS
Build Number: ${env.BUILD_NUMBER}
"""
      )
    }

    failure {
      // If post actions fail, STAGE_NAME becomes "Declarative: Post Actions".
      // So we prefer the captured FAIL_STAGE.
      script {
        def failedAt = (env.FAIL_STAGE?.trim()) ? env.FAIL_STAGE : env.STAGE_NAME
        mail(
          to: "${env.NOTIFY_TO}",
          subject: "Pipeline",
          body: """FAILURE
Build Number: ${env.BUILD_NUMBER}
Failed Stage: ${failedAt}

Console: ${env.BUILD_URL}console
"""
        )
      }
    }

    always {
      // Don't let workspace cleanup break the result reporting
      script {
        try {
          cleanWs()
        } catch (e) {
          echo "cleanWs failed: ${e}"
        }
      }
    }
  }
}
