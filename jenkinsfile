pipeline {

  agent any

  parameters {
    string(name: 'BRANCH_NAME',  defaultValue: 'br2' , description: 'Select branch')
    choice(name: 'ENV', choices: ['dev', 'qa', 'prod'], description: 'Select Environment')
  }

  environment {
    APP_NAME  = "myapp"
    NOTIFY_TO = "sabinashaik228@gmail.com"
  }

  tools {
    maven "MAVEN3"
    jdk "JDK21"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: "${params.BRANCH_NAME}",
            url: 'https://github.com/sabinashaik/myapp.git',
            credentialsId: 'github-creds'
      }
    }

    stage('Read Properties') {
      steps {
        script {
          def lines = readFile('jenkins/pipeline.properties').split('\n')

          lines.each { line ->
            if (line.startsWith("sonar.server="))
              env.SONAR_SERVER = line.split('=')[1].trim()

            if (line.startsWith("mvn.cmd="))
              env.MVN_CMD = line.split('=')[1].trim()

            if (line.startsWith("context.path="))
              env.CONTEXT_PATH = line.split('=')[1].trim()

            if (line.startsWith("${params.ENV}.tomcat.url="))
              env.TOMCAT_URL = line.split('=')[1].trim()

            if (line.startsWith("${params.ENV}.tomcat.creds="))
              env.TOMCAT_CREDS = line.split('=')[1].trim()
          }

          if (!env.TOMCAT_URL || !env.TOMCAT_CREDS) {
            error "Missing Tomcat values for ENV=${params.ENV}"
          }

          // safety: ensure leading /
          if (env.CONTEXT_PATH && !env.CONTEXT_PATH.startsWith('/')) {
            env.CONTEXT_PATH = "/${env.CONTEXT_PATH}"
          }

          echo "Loaded properties for ENV=${params.ENV}, CONTEXT_PATH=${env.CONTEXT_PATH}"
        }
      }
    }

    stage('Build + Test + Package') {
      steps {
        sh "${env.MVN_CMD}"
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv("${env.SONAR_SERVER}") {
          sh 'mvn sonar:sonar'
        }
      }
    }

    stage('Upload to Nexus') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'nexus-creds',
          usernameVariable: 'NEXUS_USER',
          passwordVariable: 'NEXUS_PASS'
        )]) {
          sh '''
            mvn deploy -DskipTests \
              -Dnexus.username=$NEXUS_USER \
              -Dnexus.password=$NEXUS_PASS
          '''
        }
      }
    }

    // ✅ Deploy on success path
    stage('Deploy to Tomcat') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: "${env.TOMCAT_CREDS}",
          usernameVariable: 'TOMCAT_USER',
          passwordVariable: 'TOMCAT_PASS'
        )]) {
          sh """
            echo "Deploying WAR to ${env.TOMCAT_URL} with context ${env.CONTEXT_PATH}"
            ls -l target || true

            curl --fail -u \$TOMCAT_USER:\$TOMCAT_PASS \
              -T target/${APP_NAME}.war \
              "${env.TOMCAT_URL}/deploy?path=${env.CONTEXT_PATH}&update=true"
          """
        }
      }
    }
  }

  post {

    success {
      emailext(
        subject: "Pipeline",
        body: """SUCCESS
Job: ${env.JOB_NAME}
Build Number: ${env.BUILD_NUMBER}
ENV: ${params.ENV}
Branch: ${params.BRANCH_NAME}
""",
        to: "${env.NOTIFY_TO}"
      )
    }

    // ✅ Undeploy only when pipeline fails
    failure {

      script {
        if (env.TOMCAT_URL && env.TOMCAT_CREDS && env.CONTEXT_PATH) {
          withCredentials([usernamePassword(
            credentialsId: "${env.TOMCAT_CREDS}",
            usernameVariable: 'TOMCAT_USER',
            passwordVariable: 'TOMCAT_PASS'
          )]) {
            sh """
              echo "Pipeline FAILED -> undeploying ${env.CONTEXT_PATH} from ${env.TOMCAT_URL}"
              curl --fail -u \$TOMCAT_USER:\$TOMCAT_PASS \
                "${env.TOMCAT_URL}/undeploy?path=${env.CONTEXT_PATH}"
            """
          }
        } else {
          echo "Skipping undeploy (Tomcat values not available)"
        }
      }

      emailext(
        subject: "Pipeline",
        body: """FAILURE
Job: ${env.JOB_NAME}
Build Number: ${env.BUILD_NUMBER}
ENV: ${params.ENV}
Branch: ${params.BRANCH_NAME}
""",
        to: "${env.NOTIFY_TO}"
      )
    }

    always {
      cleanWs()
    }
  }
}
