pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        TOMCAT_URL   = "http://52.203.118.246:8082/manager/text"
        APP_NAME     = "myapp"
        NOTIFY_TO    = "sabinashaik228@gmail.com"
        FAILED_STAGE = ""   // will be filled before each stage runs
    }

    tools {
        maven "MAVEN3"
        jdk "JDK21"
    }

    stages {

        stage('Checkout') {
            steps {
                script { env.FAILED_STAGE = "Checkout" }
                git branch: 'main',
                    url: 'https://github.com/sabinashaik/myapp.git',
                    credentialsId: 'github-creds'
            }
        }

        stage('Build + Test + Package') {
            steps {
                script { env.FAILED_STAGE = "Build + Test + Package" }
                sh 'mvn -U clean test package'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script { env.FAILED_STAGE = "SonarQube Analysis" }
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                script { env.FAILED_STAGE = "Upload to Nexus" }
                withCredentials([usernamePassword(
                    credentialsId: 'nexus-creds',
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh '''
                      mvn deploy -DskipTests \
                        -Dnexus.username=$NEXUS_USER \
                        -Dnexus.password=$NEXUS_PASS
                    '''
                }
            }
        }

        stage('Deploy to Tomcat (Docker)') {
            steps {
                script { env.FAILED_STAGE = "Deploy to Tomcat (Docker)" }
                withCredentials([usernamePassword(
                    credentialsId: 'tomcat-creds',
                    usernameVariable: 'TOMCAT_USER',
                    passwordVariable: 'TOMCAT_PASS'
                )]) {
                    sh '''
                      set -e
                      echo "Deploying WAR to Tomcat..."
                      ls -l target || true

                      # Fail pipeline if Tomcat returns 4xx/5xx
                      curl --fail -v -u $TOMCAT_USER:$TOMCAT_PASS \
                        -T target/${APP_NAME}.war \
                        "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"
                    '''
                }
            }
        }
    }

    post {
        success {
            emailext(
                subject: "Pipeline",
                body: """SUCCESS
Build Number: ${env.BUILD_NUMBER}
""",
                to: "${env.NOTIFY_TO}"
            )
        }

        failure {
            emailext(
                subject: "Pipeline",
                body: """FAILURE
Build Number: ${env.BUILD_NUMBER}
Failed Stage: ${env.FAILED_STAGE}
""",
                to: "${env.NOTIFY_TO}"
            )
        }

        always {
            cleanWs()
        }
    }
}
