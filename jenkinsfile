pipeline {
  agent any
  triggers { githubPush() }

  environment {
    TOMCAT_URL = "http://52.203.118.246:8082/manager/text"
    APP_NAME   = "myapp"
    NOTIFY_TO  = "sabinashaik228@gmail.com"
    LAST_STAGE = "Checkout"
  }

  tools {
    maven "MAVEN3"
    jdk "JDK21"
  }

  stages {

    stage('Checkout') {
      steps {
        script { env.LAST_STAGE = "Checkout" }
        git branch: 'main',
            url: 'https://github.com/sabinashaik/myapp.git',
            credentialsId: 'github-creds'
      }
    }

    stage('Build + Test + Package') {
      steps {
        script { env.LAST_STAGE = "Build + Test + Package" }
        sh 'mvn -U clean test package'
      }
    }

    stage('SonarQube') {
      steps {
        script { env.LAST_STAGE = "SonarQube" }
        withSonarQubeEnv('SonarQube') {
          sh 'mvn sonar:sonar'   // IMPORTANT: correct goal
        }
      }
    }

    stage('Upload to Nexus') {
      steps {
        script { env.LAST_STAGE = "Upload to Nexus" }
        withCredentials([usernamePassword(
          credentialsId: 'nexus-creds',
          usernameVariable: 'NEXUS_USER',
          passwordVariable: 'NEXUS_PASS'
        )]) {
          sh '''
            mvn deploy -DskipTests \
              -Dnexus.username=$NEXUS_USER \
              -Dnexus.password=$NEXUS_PASS
          '''
        }
      }
    }

    stage('Deploy to Tomcat (Docker)') {
      steps {
        script { env.LAST_STAGE = "Deploy to Tomcat (Docker)" }
        withCredentials([usernamePassword(
          credentialsId: 'tomcat-creds',
          usernameVariable: 'TOMCAT_USER',
          passwordVariable: 'TOMCAT_PASS'
        )]) {
          sh '''
            set -e
            echo "Deploying WAR to Tomcat..."
            ls -l target || true

            curl --fail -v -u $TOMCAT_USER:$TOMCAT_PASS \
              -T target/${APP_NAME}.war \
              "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"
          '''
        }
      }
    }
  }

  post {
    success {
      mail(
        to: "${env.NOTIFY_TO}",
        subject: "Pipeline",
        body: """Pipeline SUCCESS
Build Number: ${env.BUILD_NUMBER}
"""
      )
    }

    failure {
      script {
        // If Jenkins says "Declarative: Post Actions", show the last stage we entered
        def failedStage = (env.STAGE_NAME == 'Declarative: Post Actions') ? env.LAST_STAGE : env.STAGE_NAME

        mail(
          to: "${env.NOTIFY_TO}",
          subject: "Pipeline",
          body: """Pipeline FAILURE
Build Number: ${env.BUILD_NUMBER}
Failed Stage: ${failedStage}
${env.BUILD_URL}console
"""
        )
      }
    }

    always {
      // optional cleanup; do NOT fail the build if cleanup fails
      script {
        try { cleanWs() } catch (e) { echo "cleanWs failed: ${e}" }
      }
    }
  }
}
